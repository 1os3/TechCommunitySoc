# 向量化个性推荐系统实施计划

## 核心设计理念

### 推荐方式
- **随机采样策略**: 每次从全量帖子中随机采样N个帖子（N=10000）
- **向量匹配**: 使用Qwen3-Embedding模型计算用户偏好向量与帖子向量的相似度
- **渐进式展示**: 从N个样本中筛选匹配度最高的M个展示给用户（M=10）
- **循环推荐**: 用户滑完M个后，重新采样N个，再筛选M个，如此循环

### 数据流程
```
随机采样10000个帖子 → 获取向量 → 计算相似度 → 排序取前10个 → 展示给用户
↓ 用户滑完10个
重新随机采样10000个 → ... → 展示下一批10个
```

### 技术栈
- **向量模型**: Qwen3-Embedding-0.6B-GGUF (256维向量)
- **部署方式**: Docker + Modelscope云服务
- **向量存储**: PostgreSQL + pgvector扩展
- **相似度计算**: 余弦相似度（内存计算）

---

## 实施任务列表

### 阶段1: 基础设施建设

- [ ] **1.1 向量模型部署**
  - 配置Qwen3-Embedding Docker容器
  - 设置Modelscope云服务服务和模型下载
  - 创建向量化API服务接口
  - 编写向量化服务的单元测试
  - _技术需求: Docker, Modelscope云服务, Qwen3模型_

- [ ] **1.2 数据库向量扩展**
  - 安装PostgreSQL pgvector扩展
  - 创建post_vectors表存储帖子向量
  - 创建user_preference_vectors表存储用户偏好向量
  - 创建向量索引优化查询性能
  - 编写数据库向量操作的集成测试
  - _依赖需求: PostgreSQL已完成迁移_

- [ ] **1.3 向量化服务实现**
  - 实现Qwen3VectorService类
  - 创建文本预处理和向量化接口
  - 实现批量向量化功能
  - 添加向量化错误处理和重试机制
  - 编写向量化服务的性能测试
  - _依赖需求: 1.1完成_

### 阶段2: 数据模型改造

- [ ] **2.1 Post模型向量集成**
  - 修改Post模型添加向量化钩子
  - 实现新帖子创建时自动向量化
  - 实现帖子更新时重新向量化
  - 添加向量化状态跟踪字段
  - 编写Post向量化的集成测试
  - _依赖需求: 1.2, 1.3完成_

- [ ] **2.2 用户偏好向量构建**
  - 修改UserPreferenceService支持向量输出
  - 实现基于用户交互历史的偏好向量计算
  - 创建向量加权平均算法
  - 实现用户偏好向量的增量更新机制
  - 编写用户偏好向量的单元测试
  - _依赖需求: 1.3完成, 现有8.1用户行为追踪_

- [ ] **2.3 向量数据迁移**
  - 创建现有帖子的批量向量化脚本
  - 实现向量化进度跟踪和断点续传
  - 处理向量化失败的帖子
  - 验证向量化数据的完整性
  - 编写数据迁移的回滚机制
  - _依赖需求: 2.1完成_

### 阶段3: 随机采样推荐引擎

- [ ] **3.1 随机采样服务**
  - 实现RandomSamplingService类
  - 创建高效的随机采样SQL查询
  - 实现采样去重和过滤逻辑（排除用户已读）
  - 添加采样性能优化（索引利用）
  - 编写采样服务的性能测试
  - _依赖需求: 2.1完成_

- [ ] **3.2 向量相似度计算**
  - 实现余弦相似度计算函数
  - 创建批量向量相似度计算服务
  - 优化内存使用和计算性能
  - 实现相似度计算的并行处理
  - 编写相似度计算的单元测试
  - _依赖需求: 2.2完成_

- [ ] **3.3 推荐排序和筛选**
  - 实现推荐结果排序算法
  - 创建多样性优化机制（避免同类帖子扎堆）
  - 实现推荐结果的质量评分
  - 添加推荐解释生成功能
  - 编写推荐排序的单元测试
  - _依赖需求: 3.1, 3.2完成_

### 阶段4: 渐进式推荐API

- [ ] **4.1 推荐会话管理**
  - 设计推荐会话状态存储结构
  - 实现会话生命周期管理
  - 创建会话状态的Redis缓存
  - 实现会话超时和清理机制
  - 编写会话管理的集成测试
  - _技术需求: Redis缓存_

- [ ] **4.2 渐进式推荐API端点**
  - 创建/api/recommendations/session端点（开始推荐会话）
  - 创建/api/recommendations/next端点（获取下一批推荐）
  - 实现推荐反馈收集接口
  - 添加推荐API的请求验证
  - 编写推荐API的集成测试
  - _依赖需求: 3.3, 4.1完成_

- [ ] **4.3 推荐效果追踪**
  - 实现推荐点击率统计
  - 创建推荐满意度反馈机制
  - 实现A/B测试支持
  - 添加推荐效果数据收集
  - 编写推荐效果分析工具
  - _依赖需求: 4.2完成_

### 阶段5: 行为追踪集成

- [ ] **5.1 行为追踪中间件升级**
  - 修改behaviorTracking中间件触发向量更新
  - 实现异步用户偏好向量重计算
  - 添加向量更新的防抖机制
  - 优化向量更新的性能影响
  - 编写升级后行为追踪的测试
  - _依赖需求: 2.2完成, 现有8.1行为追踪_

- [ ] **5.2 实时偏好学习**
  - 实现基于实时交互的偏好向量调整
  - 创建偏好向量的时间衰减机制
  - 实现新用户冷启动策略
  - 添加偏好学习的自适应权重
  - 编写实时学习的单元测试
  - _依赖需求: 5.1完成_

- [ ] **5.3 推荐反馈循环**
  - 实现推荐结果与用户行为的关联
  - 创建推荐模型的在线学习机制
  - 实现负反馈处理（用户不感兴趣）
  - 添加推荐多样性动态调节
  - 编写反馈循环的集成测试
  - _依赖需求: 4.3, 5.2完成_

### 阶段6: 性能优化与缓存

- [ ] **6.1 向量缓存策略**
  - 实现热门帖子向量的内存缓存
  - 创建用户偏好向量的缓存机制
  - 实现向量缓存的更新策略
  - 添加缓存命中率监控
  - 编写缓存系统的性能测试
  - _依赖需求: 阶段3完成_

- [ ] **6.2 采样优化**
  - 优化随机采样的SQL性能
  - 实现采样结果的短期缓存
  - 创建采样偏差检测机制
  - 添加采样质量监控
  - 编写采样优化的基准测试
  - _依赖需求: 3.1完成_

- [ ] **6.3 计算性能优化**
  - 实现向量计算的批处理优化
  - 创建相似度计算的并行处理
  - 优化内存使用和垃圾回收
  - 添加计算性能监控指标
  - 编写性能优化的压力测试
  - _依赖需求: 3.2完成_

### 阶段7: 前端集成接口

- [ ] **7.1 推荐数据格式标准化**
  - 定义推荐结果的JSON格式规范
  - 实现推荐元数据的标准化输出
  - 创建推荐解释信息的格式化
  - 添加前端兼容性验证
  - 编写数据格式的文档和测试
  - _依赖需求: 4.2完成_

- [ ] **7.2 推荐API性能优化**
  - 实现推荐结果的增量加载
  - 创建推荐预加载机制
  - 优化API响应时间
  - 添加API限流和防滥用
  - 编写API性能的基准测试
  - _依赖需求: 6.3完成_

- [ ] **7.3 推荐状态同步**
  - 实现推荐会话的状态同步
  - 创建多设备推荐状态共享
  - 实现推荐进度的持久化
  - 添加推荐状态的错误恢复
  - 编写状态同步的集成测试
  - _依赖需求: 4.1完成_

### 阶段8: 测试与质量保证

- [ ] **8.1 推荐质量测试**
  - 创建推荐质量评估指标
  - 实现推荐结果的人工评测
  - 创建推荐多样性测试用例
  - 实现推荐偏差检测
  - 编写推荐质量的自动化测试
  - _依赖需求: 阶段4完成_

- [ ] **8.2 系统压力测试**
  - 实现并发推荐请求的压力测试
  - 创建大规模用户的模拟测试
  - 测试向量化服务的极限性能
  - 实现系统稳定性测试
  - 编写压力测试报告和优化建议
  - _依赖需求: 阶段6完成_

- [ ] **8.3 端到端集成测试**
  - 创建完整推荐流程的E2E测试
  - 实现多用户场景的集成测试
  - 测试推荐系统与现有功能的兼容性
  - 创建回归测试套件
  - 编写集成测试的自动化流程
  - _依赖需求: 阶段7完成_

### 阶段9: 监控与运维

- [ ] **9.1 推荐系统监控**
  - 实现推荐服务的健康检查
  - 创建推荐质量的实时监控
  - 实现向量化服务的状态监控
  - 添加推荐性能指标收集
  - 编写监控告警的配置和测试
  - _依赖需求: 阶段8完成_

- [ ] **9.2 数据备份与恢复**
  - 实现向量数据的备份策略
  - 创建推荐模型的版本管理
  - 实现数据恢复的自动化流程
  - 添加数据一致性验证
  - 编写备份恢复的操作手册
  - _依赖需求: 阶段1完成_

- [ ] **9.3 系统升级与维护**
  - 创建推荐系统的升级策略
  - 实现零停机的服务更新
  - 创建配置管理和版本控制
  - 实现系统维护的自动化脚本
  - 编写运维操作的标准文档
  - _依赖需求: 9.1, 9.2完成_

---

## 技术架构总览

### 核心组件
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户请求       │    │   随机采样       │    │   向量匹配       │
│   推荐会话       │───▶│   10000帖子     │───▶│   筛选前10个     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         ▲                                               │
         │                                               ▼
┌─────────────────┐                            ┌─────────────────┐
│   用户滑完       │                            │   展示给用户     │
│   重新采样       │◀───────────────────────────│   等待滑动       │
└─────────────────┘                            └─────────────────┘
```

### 数据表结构
```sql
-- 帖子向量表
post_vectors (
  post_id INTEGER PRIMARY KEY,
  vector VECTOR(256),
  created_at TIMESTAMP
)

-- 用户偏好向量表
user_preference_vectors (
  user_id INTEGER PRIMARY KEY, 
  preference_vector VECTOR(256),
  last_updated TIMESTAMP
)

-- 推荐会话表
recommendation_sessions (
  session_id UUID PRIMARY KEY,
  user_id INTEGER,
  current_sample JSONB,
  shown_posts INTEGER[],
  created_at TIMESTAMP,
  expires_at TIMESTAMP
)
```

### API接口设计
```typescript
// 开始推荐会话
POST /api/recommendations/session
Response: { sessionId: string, recommendations: Post[] }

// 获取下一批推荐
GET /api/recommendations/next?sessionId=xxx
Response: { recommendations: Post[], hasMore: boolean }

// 推荐反馈
POST /api/recommendations/feedback
Body: { sessionId: string, postId: number, action: 'like'|'dislike'|'skip' }
```

---

## 性能目标

- **推荐响应时间**: < 200ms (90%请求)
- **向量化时间**: < 2s (单帖子)
- **系统并发**: 支持1000+并发推荐请求  
- **推荐质量**: 点击率 > 5%, 停留时间 > 30s
- **可用性**: 99.9%服务可用性

## 里程碑时间线

- **阶段1-2 (基础建设)**: 2周
- **阶段3-4 (核心推荐)**: 3周  
- **阶段5-6 (优化集成)**: 2周
- **阶段7-8 (前端测试)**: 2周
- **阶段9 (监控运维)**: 1周

**总计预估**: 10周完成完整向量推荐系统

---

*向量化个性推荐系统 v1.0 | 基于Qwen3-Embedding | 随机采样+渐进式展示*